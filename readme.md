# Pixel Battles

## Постановка задачи

Дана карта 100х100, реализовано REST API для окрашивания клетки в цвет.
Исходно карта выполнена в виде одномерного массива и доступ к нему осуществляется из критической секции.

Требуется оптимизировать конкурентный доступ к карте. Структуру данных для хранения поля можно изменить по вашему
усмотрению.

Помимо технической реализации проекта, потребуется ниже описать вашу идею оптимизации и примененные техники.

В тестах приведен пример нагрузочного тестирования. Прежде чем приступать к заданию, стоит замерить производительность
образца.
И затем сравнивать результаты после оптимизации.

![](./screen.png)

## Описание идеи

Основная идея оптимизации доступа к карте состоял в том, чтобы блокировать не весь массив (как в исходном алгоритме), а
блокировать сами элементы массива при попытке записи нового значения. Таким образом, если в исходном алгоритме один
поток, получивший доступ к общему ресурсу, блокирует доступ для всех других потоков. Если блокировать только одну клетку
карты при записи нового значения, то остальные потоки могут свободно изменять цвета других клеткок. Ожидание доступа к
ресурсу должно возникать только когда несколько потоков хотят изменить цвет одной клетки.

Данную идею я попробовал реализовать двумя подходами: блокирующим и неблокирующим. Для реализации блокирующего подхода
я создал отдельный класс элемента массива, где метод изменения значения помечен как synchronized, а значит только один
поток может менять цвет клетки в момент времени. Неблокирующий подход я реализовал, заменив тип данных элементов массива
на AtomicInteger. Используя технику Compare and Swap, я добился синхронизации значения отдельной клетки между потоками.
То есть, когда поток пытает изменить значение клетки, он сохраняет её значение до записи, а при записи проверяет
равенство прочитанного ранее значения с текущим, если они не равны, то поток будет повторять попытку записи. При таком
подходе ни один поток не будет находиться в состоянии ожидания, однако может длительное время безуспешно пытаться
произвести запись.

Для сравнения различных подходов я запустил тест по 10 раз. Большое число повторений необходимо, чтобы сгладить
погрешность, получающуюся из-за того, что потоки случайным образом выбирают ячейки для записи. В результате наилучшее
среднее время записи показал неблокирующий подход (52,7106 мс.), чуть хуже оказался блокирующий. Оба подхода по среднему
времени записи превзошли исходный алгоритм. По максимальному времени записи лучше всего оказался неблокирующий подход
(1894 мс.), а блокирующий уступил исходному.

### Исходная статистика времени доступа к карте

- Тест 1: LongSummaryStatistics{count=10000, sum=555588, min=0, average=55,558800, max=2158}
- Тест 2: LongSummaryStatistics{count=10000, sum=569912, min=0, average=56,991200, max=1621}
- Тест 3: LongSummaryStatistics{count=10000, sum=444230, min=1, average=44,423000, max=1820}
- Тест 4: LongSummaryStatistics{count=10000, sum=817892, min=1, average=81,789200, max=3163}
- Тест 5: LongSummaryStatistics{count=10000, sum=503075, min=1, average=50,307500, max=1650}
- Тест 6: LongSummaryStatistics{count=10000, sum=494981, min=0, average=49,498100, max=1956}
- Тест 7: LongSummaryStatistics{count=10000, sum=468727, min=1, average=46,872700, max=1927}
- Тест 8: LongSummaryStatistics{count=10000, sum=618227, min=1, average=61,822700, max=1800}
- Тест 9: LongSummaryStatistics{count=10000, sum=488552, min=1, average=48,855200, max=1785}
- Тест 10: LongSummaryStatistics{count=10000, sum=625531, min=1, average=62,553100, max=2246}
- Среднее: sum=558672, average=55,8672, max=2013

### Статистика доступа к карте после оптимизации (неблокирующий подход - AtomicInteger[])

- Тест 1: LongSummaryStatistics{count=10000, sum=629513, min=0, average=62,951300, max=2094}
- Тест 2: LongSummaryStatistics{count=10000, sum=482001, min=1, average=48,200100, max=2021}
- Тест 3: LongSummaryStatistics{count=10000, sum=574362, min=0, average=57,436200, max=1799}
- Тест 4: LongSummaryStatistics{count=10000, sum=426595, min=0, average=42,659500, max=898}
- Тест 5: LongSummaryStatistics{count=10000, sum=525887, min=0, average=52,588700, max=2391}
- Тест 6: LongSummaryStatistics{count=10000, sum=394357, min=0, average=39,435700, max=1433}
- Тест 7: LongSummaryStatistics{count=10000, sum=506009, min=1, average=50,600900, max=1489}
- Тест 8: LongSummaryStatistics{count=10000, sum=717461, min=1, average=71,746100, max=3203}
- Тест 9: LongSummaryStatistics{count=10000, sum=458534, min=1, average=45,853400, max=1922}
- Тест 10: LongSummaryStatistics{count=10000, sum=556338, min=0, average=55,633800, max=1689}
- Среднее: sum=527106, average=52,7106, max=1894

### Статистика доступа к карте после оптимизации (блокирующий подход - SyncElement[])

- Тест 1: LongSummaryStatistics{count=10000, sum=574537, min=0, average=57,453700, max=2354}
- Тест 2: LongSummaryStatistics{count=10000, sum=459332, min=0, average=45,933200, max=2358}
- Тест 3: LongSummaryStatistics{count=10000, sum=526630, min=1, average=52,663000, max=1826}
- Тест 4: LongSummaryStatistics{count=10000, sum=604337, min=0, average=60,433700, max=1995}
- Тест 5: LongSummaryStatistics{count=10000, sum=588211, min=0, average=58,821100, max=1904}
- Тест 6: LongSummaryStatistics{count=10000, sum=462755, min=0, average=46,275500, max=1846}
- Тест 7: LongSummaryStatistics{count=10000, sum=598256, min=0, average=59,825600, max=3576}
- Тест 8: LongSummaryStatistics{count=10000, sum=616173, min=0, average=61,617300, max=1704}
- Тест 9: LongSummaryStatistics{count=10000, sum=405742, min=0, average=40,574200, max=1507}
- Тест 10: LongSummaryStatistics{count=10000, sum=488023, min=0, average=48,802300, max=2217}
- Среднее: sum=532400, average=53,2400, max=2129